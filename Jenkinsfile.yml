pipeline {
    agent any
    tools {
        nodejs "node"
    }
    triggers {
        githubPush()
    } 
    stages {
        stage('Build') {
            steps {
                sh 'npm install'
                sh 'npm run build'
            }
        }
        stage('Upload build folder to Nexus') {
            steps {
                script {
                    //def mavenPom = readMavenPom file: 'pom.xml' // Used to get data from pom.xml
                    def props = readProperties file: 'env'
                    env.VERSION = props.VERSION
                    echo "Version is ${VERSION}"
                
                }
            }
        }
    }
    post('Generate report') { 
	    always {
            script {
                // Sends HTTP POST request in JSON format
                def props = readProperties file: 'env'
                //def mavenPom = readMavenPom file: 'pom.xml'
                env.VERSION = props.VERSION
                //echo "Version is ${VERSION}"
                def jobdetails = "${JOB_NAME}-${env.BUILD_NUMBER}"
                def jobstatus = "${currentBuild.result}"
                def myJson = "{\"Job details\": \"${jobdetails}\", \"Build status\": \"${jobstatus}\", \"Version\": \"${VERSION}\"}";
                echo "${myJson}"
                if("${currentBuild.result}" == "SUCCESS") {
                    def destination_ip = "http://localhost:1080" // destination_ip of the server which listens the requests
                    sh "curl -v -H 'Content-Type: application/json' -X POST -d '${myJson}' ${destination_ip}" 
                }
                else {
                    echo 'Build failed/aborted'
                }
                /*
                // Sends an email notification to the developer
				emailext subject: "Automation Result: Job '${env.JOB_NAME} - ${env.BUILD_NUMBER}'", 
				body: "${env.BUILD_URL} has result ${currentBuild.result}",
				to:'$DEFAULT_RECIPIENTS'
                */
			}
		}
    }
}